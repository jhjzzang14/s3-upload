# .github/workflows/deploy.yml

name: Deploy S3 Upload Service

# main ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy S3 Upload Service
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub Repositoryì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. S3 ì—…ë¡œë“œ ì„œë¹„ìŠ¤ íŒŒì¼ë“¤ì„ ì„œë²„ì— ë³µì‚¬í•©ë‹ˆë‹¤.
      - name: Copy S3 upload service files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "main.py,requirements.txt,templates/,start.sh,README.md"
          target: ${{ secrets.TARGET }}
          strip_components: 0

      # 3. ì„œë²„ì—ì„œ Python í™˜ê²½ ì„¤ì • ë° S3 ì—…ë¡œë“œ ì„œë²„ ì‹œì‘
      - name: Setup and restart S3 upload server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # ëŒ€ìƒ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ${{ secrets.TARGET }}
            
            # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x start.sh
            
            # ê¸°ì¡´ S3 ì—…ë¡œë“œ ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (í¬íŠ¸ 8888 ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤)
            echo "ğŸ” Checking for existing processes on port 8888..."
            PID=$(lsof -ti:8888 || echo "")
            if [ ! -z "$PID" ]; then
              echo "ğŸ›‘ Stopping existing S3 upload server (PID: $PID)..."
              kill -9 $PID || true
              sleep 2
            fi
            
            # GitHub Secretsì„ ì‚¬ìš©í•´ì„œ .env íŒŒì¼ ìƒì„±
            echo "ğŸ“ Creating .env file from GitHub secrets..."
            cat > .env << EOF
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            S3_BASE_URL=${{ secrets.S3_BASE_URL }}
            EOF
            
            # ë¹Œë“œ ë„êµ¬ ë° pip ì„¤ì¹˜
            echo "ğŸ”§ Installing build tools and pip..."
            sudo apt-get update
            sudo apt-get install -y python3.8-dev build-essential python3.8-distutils curl
            
            # pipê°€ ì—†ìœ¼ë©´ ì„¤ì¹˜
            if ! python3.8 -m pip --version > /dev/null 2>&1; then
              curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
              python3.8 get-pip.py --user
              rm get-pip.py
            fi
            
            # virtualenv ì„¤ì¹˜
            python3.8 -m pip install --user virtualenv
            
            # Python ê°€ìƒí™˜ê²½ì´ ì—†ìœ¼ë©´ ìƒì„±
            if [ ! -d "venv" ]; then
              echo "ğŸ Creating Python virtual environment..."
              python3.8 -m virtualenv venv
            fi
            
            # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ Installing Python dependencies..."
            source venv/bin/activate
            pip install --upgrade pip setuptools wheel
            pip install -r requirements.txt
            
            # ë°±ê·¸ë¼ìš´ë“œì—ì„œ S3 ì—…ë¡œë“œ ì„œë²„ ì‹œì‘
            echo "ğŸš€ Starting S3 upload service..."
            nohup venv/bin/python main.py > s3-upload.log 2>&1 &
            
            # ì„œë²„ ì‹œì‘ í™•ì¸
            sleep 5
            if lsof -ti:8888 > /dev/null; then
              echo "âœ… S3 upload service started successfully on port 8888"
              echo "ğŸ“ Access URL: http://$(hostname -I | awk '{print $1}'):8888"
            else
              echo "âŒ Failed to start S3 upload service"
              echo "ğŸ“‹ Server log:"
              tail -20 s3-upload.log || echo "No log file found"
              exit 1
            fi